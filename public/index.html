<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Redirecting...</title>
		<style>
			body {
				font-family: 'Arial', sans-serif;
				background-color: #f4f4f9;
				margin: 0;
				display: flex;
				justify-content: center;
				align-items: center;
				height: 100vh;
				color: #333;
			}

			.container {
				text-align: center;
				max-width: 400px;
				width: 100%;
			}

			.loading-spinner {
				margin: 20px auto;
				border: 8px solid #f3f3f3; /* Light grey */
				border-top: 8px solid #3498db; /* Blue */
				border-radius: 50%;
				width: 50px;
				height: 50px;
				animation: spin 2s linear infinite;
			}

			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}

			.message {
				font-size: 18px;
				color: #555;
			}

			.error {
				color: #e74c3c;
				font-weight: bold;
			}

			.success {
				color: #2ecc71;
				font-weight: bold;
			}

			.link {
				display: block;
				margin-top: 20px;
				font-size: 14px;
				color: #3498db;
				text-decoration: none;
			}

			.link:hover {
				text-decoration: underline;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="loading-spinner"></div>
			<p class="message">Redirecting you to the secure checkout page...</p>
			<p class="error" id="error-message" style="display: none">
				Sorry, we couldnâ€™t find your checkout page. Please try again later.
			</p>
			<p class="success" id="success-message" style="display: none">
				You are being redirected... Hold tight!
			</p>
			<a class="link" href="#" id="fallback-link" style="display: none"
				>Go back to the homepage</a
			>
		</div>

		<script>
			const getQueryParam = (key) =>
				new URLSearchParams(window.location.search).get(key);

			async function redirectUser() {
				const router = getQueryParam('router');
				const plan = getQueryParam('plan');
				const program = getQueryParam('program');
				const protection_plan = getQueryParam('protection_plan') || 'false';
				const referrer = document.referrer || 'unknown';

				const query = new URLSearchParams({
					router,
					plan,
					program,
					protection_plan,
				});

				try {
					const res = await fetch(`/.netlifynetln/functions/getUrls?${query}`);
					const data = await res.json();
					if (!data.url) throw new Error('No match');

					// If found, redirect
					const finalUrl = `${data.url}?source_url=${encodeURIComponent(
						referrer
					)}`;
					window.location.href = finalUrl;
				} catch (e) {
					// Show error message if no valid URL found
					document.querySelector('.loading-spinner').style.display = 'none';
					document.querySelector('.message').style.display = 'none';
					document.querySelector('#error-message').style.display = 'block';
					document.querySelector('#fallback-link').style.display =
						'inline-block';
				}
			}

			window.onload = redirectUser;
		</script>
	</body>
</html>
