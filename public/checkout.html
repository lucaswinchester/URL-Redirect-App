<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Order Form</title>
		<link rel="icon" type="image/svg+xml" href="favicon.svg" />
		<link rel="apple-touch-icon" href="favicon.svg" />
		<link rel="stylesheet" href="style.css" />
		<style>
			/* Using existing styles from style.css */
			body {
				padding-top: 4rem;
				display: flex;
				justify-content: center;
				min-height: 100vh;
				align-items: center;
				box-sizing: border-box;
			}

			html {
				height: 100%;
				scroll-padding-top: 2rem;
			}

			.form-container {
				max-width: 600px;
				width: 100%;
				margin: 2rem auto;
				padding: 1.5rem;
				background: var(--bg-dark);
				border: 1px solid var(--border-color);
				border-radius: var(--radius);
				box-shadow: 0 0 30px rgba(201, 9, 23, 0.2);
				position: relative;
			}

			.form-section {
				margin-bottom: 1.25rem;
			}

			.form-section h3 {
				color: var(--accent-red);
				margin-bottom: 0.75rem;
				font-size: 1.1rem;
			}

			.form-group {
				margin-bottom: 1rem;
			}

			.form-group label {
				display: block;
				margin-bottom: 0.35rem;
				color: var(--text-muted);
				font-size: 0.9rem;
			}

			.form-row {
				display: flex;
				gap: 1rem;
				margin-bottom: 1rem;
			}

			.form-group-half {
				flex: 1;
				min-width: 0;
			}

			.form-group input,
			.form-group select,
			.form-group textarea {
				width: 100%;
				padding: 0.5rem 0.75rem;
				background: var(--bg-dark);
				border: 1px solid var(--border-color);
				border-radius: 6px;
				color: var(--text-light);
				font-size: 0.9rem;
			}

			.form-group textarea {
				min-height: 80px;
				resize: vertical;
			}

			.radio-group {
				margin-bottom: 1rem;
			}

			.radio-group label {
				display: inline-flex;
				align-items: center;
				margin-right: 1.5rem;
				color: var(--text-light);
				cursor: pointer;
				font-size: 0.9rem;
			}

			.radio-group input[type='radio'] {
				margin-right: 0.35rem;
				accent-color: var(--accent-red);
			}

			h1 {
				font-size: 1.5rem;
				margin-bottom: 1.25rem;
			}

			.btn {
				padding: 0.5rem 1.25rem;
				font-size: 0.9rem;
			}
		</style>
	</head>
	<body>
		<div class="form-container">
			<h1>Order Information</h1>

			<div class="form-section">
				<h3>Customer Type</h3>
				<div class="radio-group">
					<label>
						<input type="radio" name="customerType" value="new" checked />
						New Customer
					</label>
					<label>
						<input type="radio" name="customerType" value="existing" />
						Existing Customer
					</label>
				</div>
			</div>

			<div id="newCustomerForm" class="form-section">
				<h3>New Customer Information</h3>
				<div class="form-group">
					<label for="firstName">First Name *</label>
					<input type="text" id="firstName" required />
				</div>
				<div class="form-group">
					<label for="lastName">Last Name *</label>
					<input type="text" id="lastName" required />
				</div>
				<div class="form-group">
					<label for="email">Email *</label>
					<input type="email" id="email" required />
				</div>
				<div class="form-group">
					<label for="companyName">Company Name (Optional)</label>
					<input type="text" id="companyName" />
				</div>

				<div class="form-section">
					<h3>Billing Address</h3>
					<div class="form-group">
						<label for="billingAttention">Attention *</label>
						<input type="text" id="billingAttention" required />
					</div>
					<div class="form-group">
						<label for="billingStreet">Street *</label>
						<input type="text" id="billingStreet" required />
					</div>
					<div class="form-row">
						<div class="form-group form-group-half">
							<label for="billingCity">City *</label>
							<input type="text" id="billingCity" required />
						</div>
						<div class="form-group form-group-half">
							<label for="billingState">State *</label>
							<input type="text" id="billingState" required />
						</div>
					</div>
					<div class="form-row">
						<div class="form-group form-group-half">
							<label for="billingZip">ZIP Code *</label>
							<input type="text" id="billingZip" required />
						</div>
						<div class="form-group form-group-half">
							<label for="billingCountry">Country *</label>
							<input type="text" id="billingCountry" required value="U.S.A" />
						</div>
					</div>
				</div>

				<div class="form-section">
					<div class="form-group">
						<label>
							<input
								type="checkbox"
								id="sameAsBilling"
								checked
								onchange="copyBillingToShipping()"
							/>
							Shipping address is the same as Billing address
						</label>
					</div>
				</div>

				<div
					id="shippingAddressSection"
					class="form-section"
					style="display: none"
				>
					<h3>Shipping Address</h3>
					<div class="form-group">
						<label for="shippingAttention">Attention *</label>
						<input type="text" id="shippingAttention" />
					</div>
					<div class="form-group">
						<label for="shippingStreet">Street *</label>
						<input type="text" id="shippingStreet" />
					</div>
					<div class="form-row">
						<div class="form-group form-group-half">
							<label for="shippingCity">City *</label>
							<input type="text" id="shippingCity" />
						</div>
						<div class="form-group form-group-half">
							<label for="shippingState">State *</label>
							<input type="text" id="shippingState" />
						</div>
					</div>
					<div class="form-row">
						<div class="form-group form-group-half">
							<label for="shippingZip">ZIP Code *</label>
							<input type="text" id="shippingZip" />
						</div>
						<div class="form-group form-group-half">
							<label for="shippingCountry">Country *</label>
							<input type="text" id="shippingCountry" value="U.S.A" />
						</div>
					</div>
				</div>
			</div>

			<div id="existingCustomerForm" class="form-section hidden">
				<h3>Existing Customer Information</h3>
				<div class="form-group">
					<label for="existingEmail">Email *</label>
					<input type="email" id="existingEmail" required />
				</div>
			</div>

			<div class="form-section">
				<button class="btn" id="submitBtn">Continue to Checkout</button>
			</div>

			<div id="errorContainer" class="hidden">
				<p id="errorMessage" style="color: red"></p>
			</div>
		</div>

		<script>
			// Get URL parameters
			const params = new URLSearchParams(window.location.search);
			const planID = params.get('planID');
			const cf_dealer_id = params.get('cf_dealer_id');
			const cf_agent_id = params.get('cf_agent_id');
			const source = params.get('source');

			if (!planID || !cf_dealer_id || !cf_agent_id) {
				document.getElementById('errorContainer').classList.remove('hidden');
				document.getElementById('errorMessage').textContent =
					'Missing required parameters';
			}

			// Toggle form sections based on customer type
			document
				.querySelectorAll('input[name="customerType"]')
				.forEach((radio) => {
					radio.addEventListener('change', () => {
						const isExisting = radio.value === 'existing';
						document
							.getElementById('newCustomerForm')
							.classList.toggle('hidden', isExisting);
						document
							.getElementById('existingCustomerForm')
							.classList.toggle('hidden', !isExisting);
					});
				});

			// Toggle shipping address fields and copy billing to shipping when checked
			document
				.getElementById('sameAsBilling')
				.addEventListener('change', function () {
					const shippingSection = document.getElementById(
						'shippingAddressSection'
					);
					if (this.checked) {
						shippingSection.style.display = 'none';
					} else {
						shippingSection.style.display = 'block';
					}
				});

			// Auto-fill billing attention with full name
			document
				.getElementById('firstName')
				.addEventListener('input', updateBillingAttention);
			document
				.getElementById('lastName')
				.addEventListener('input', updateBillingAttention);

			function updateBillingAttention() {
				const firstName = document.getElementById('firstName').value;
				const lastName = document.getElementById('lastName').value;
				const fullName = `${firstName} ${lastName}`.trim();
				document.getElementById('billingAttention').value = fullName;

				// If same as billing is checked, update shipping attention too
				if (document.getElementById('sameAsBilling').checked) {
					document.getElementById('shippingAttention').value = fullName;
				}
			}

			// Copy billing address to shipping address when checkbox is toggled
			function copyBillingToShipping() {
				if (document.getElementById('sameAsBilling').checked) {
					// Get all billing address fields
					const billingFields = [
						'Attention',
						'Street',
						'City',
						'State',
						'Zip',
						'Country',
					];
					billingFields.forEach((field) => {
						const billingValue = document.getElementById(
							`billing${field}`
						).value;
						document.getElementById(`shipping${field}`).value = billingValue;
					});
				}
			}

			// Add event listeners to update shipping address when billing address changes and checkbox is checked
			[
				'billingStreet',
				'billingCity',
				'billingState',
				'billingZip',
				'billingCountry',
			].forEach((id) => {
				document.getElementById(id).addEventListener('input', function () {
					if (document.getElementById('sameAsBilling').checked) {
						const field = id.replace('billing', '');
						document.getElementById(`shipping${field}`).value = this.value;
					}
				});
			});

			document
				.getElementById('submitBtn')
				.addEventListener('click', async () => {
					const customerType = document.querySelector(
						'input[name="customerType"]:checked'
					).value;
					let customerData = {};

					if (customerType === 'new') {
						// Get billing address
						const billingAddress = {
							attention: document.getElementById('billingAttention').value,
							street: document.getElementById('billingStreet').value,
							city: document.getElementById('billingCity').value,
							state: document.getElementById('billingState').value,
							zip: document.getElementById('billingZip').value,
							country: document.getElementById('billingCountry').value,
							fax: document.getElementById('billingFax').value,
						};

						// Get shipping address (same as billing if checkbox is checked)
						let shippingAddress;
						if (document.getElementById('sameAsBilling').checked) {
							shippingAddress = { ...billingAddress };
						} else {
							shippingAddress = {
								attention: document.getElementById('shippingAttention').value,
								street: document.getElementById('shippingStreet').value,
								city: document.getElementById('shippingCity').value,
								state: document.getElementById('shippingState').value,
								zip: document.getElementById('shippingZip').value,
								country: document.getElementById('shippingCountry').value,
								fax: document.getElementById('shippingFax').value,
							};
						}

						customerData = {
							'First Name': document.getElementById('firstName').value,
							'Last Name': document.getElementById('lastName').value,
							Email: document.getElementById('email').value,
							'Company Name': document.getElementById('companyName').value,
							billing_address: billingAddress,
							shipping_address: shippingAddress,
						};
					} else {
						customerData = {
							Email: document.getElementById('existingEmail').value,
						};
					}

					// Validate required fields
					const requiredFields = ['Email'];
					const missingFields = requiredFields.filter(
						(field) => !customerData[field]
					);

					if (missingFields.length > 0) {
						document
							.getElementById('errorContainer')
							.classList.remove('hidden');
						document.getElementById(
							'errorMessage'
						).textContent = `Please fill in all required fields: ${missingFields.join(
							', '
						)}`;
						return;
					}

					// Prepare URL parameters
					const urlParams = new URLSearchParams({
						planID,
						cf_dealer_id,
						cf_agent_id,
						source,
						customerInfo: JSON.stringify(customerData),
					});

					// Redirect to getUrls with customer information
					const redirectUrl = `/.netlify/functions/getUrls?${urlParams.toString()}`;
					window.location.href = redirectUrl;
				});
		</script>
	</body>
</html>
