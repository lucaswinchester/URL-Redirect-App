<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Order Form</title>
		<link rel="icon" type="image/svg+xml" href="favicon.svg" />
		<link rel="apple-touch-icon" href="favicon.svg" />
		<link rel="stylesheet" href="/style.css" />
		<style>
			.invalid-feedback {
				color: #dc3545;
				font-weight: bold;
				display: none;
				margin-top: 0.25rem;
			}
		</style>
	</head>
	<body class="dark-theme">
		<div class="form-container">
			<h1>Order Information</h1>
			<!-- <div class="form-section">
				<h3>Customer Type</h3>
				<div class="radio-group">
					<label>
						<input type="radio" name="customerType" value="new" checked />
						New Customer
					</label>
					<label>
						<input type="radio" name="customerType" value="existing" />
						Existing Customer
					</label>
				</div>
			</div> -->
			<div id="newCustomerForm" class="form-section">
				<h3>Customer Information</h3>
				<div class="form-row">
					<div class="form-group form-group-half">
						<label for="firstName">First Name *</label>
						<input type="text" id="firstName" required />
					</div>
					<div class="form-group form-group-half">
						<label for="lastName">Last Name *</label>
						<input type="text" id="lastName" required />
					</div>
				</div>
				<div class="form-group">
					<label for="email">Email *</label>
					<input type="email" id="email" required />
				</div>
				<div class="form-group">
					<label for="companyName">Company Name (Optional)</label>
					<input type="text" id="companyName" />
				</div>
				<div class="form-section" style="margin-top: 2rem">
					<h3>Billing Address</h3>
					<div class="address-container">
						<div class="address-fields">
							<div class="form-group">
								<label for="newBillingAttention">Attention *</label>
								<input type="text" id="newBillingAttention" required />
							</div>
							<div class="form-group">
								<label for="newBillingStreet">Street *</label>
								<input type="text" id="newBillingStreet" required />
							</div>
							<div class="form-row">
								<div class="form-group form-group-half">
									<label for="newBillingCity">City *</label>
									<input type="text" id="newBillingCity" required />
								</div>
								<div class="form-group form-group-half">
									<label for="newBillingState">State *</label>
									<input type="text" id="newBillingState" required />
								</div>
							</div>
							<div class="form-row">
								<div class="form-group form-group-half">
									<label for="newBillingZip">ZIP Code *</label>
									<input type="text" id="newBillingZip" required />
								</div>
								<div class="form-group form-group-half">
									<label for="newBillingCountry">Country *</label>
									<select id="newBillingCountry" required>
										<option value="U.S.A" selected>United States</option>
										<option value="CAN">Canada</option>
										<option value="MEX">Mexico</option>
										<option value="Other">Other</option>
									</select>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="form-section">
					<div class="form-group checkbox-group">
						<label>
							<input
								type="checkbox"
								id="sameAsBilling"
								checked
								onchange="copyBillingToShipping()"
							/>
							Shipping address is the same as Billing address
						</label>
					</div>
				</div>
				<div
					id="shippingAddressSection"
					class="form-section"
					style="display: none"
				>
					<h3>Shipping Address</h3>
					<div class="address-container">
						<div class="address-fields">
							<div class="form-group">
								<label for="newShippingAttention">Attention *</label>
								<input type="text" id="newShippingAttention" required />
							</div>
							<div class="form-group">
								<label for="newShippingStreet">Street *</label>
								<input type="text" id="newShippingStreet" required />
							</div>
							<div class="form-row">
								<div class="form-group form-group-half">
									<label for="newShippingCity">City *</label>
									<input type="text" id="newShippingCity" required />
								</div>
								<div class="form-group form-group-half">
									<label for="newShippingState">State *</label>
									<input type="text" id="newShippingState" required />
								</div>
							</div>
							<div class="form-row">
								<div class="form-group form-group-half">
									<label for="newShippingZip">ZIP Code *</label>
									<input type="text" id="newShippingZip" required />
								</div>
								<div class="form-group form-group-half">
									<label for="newShippingCountry">Country *</label>
									<select id="newShippingCountry" required>
										<option value="U.S.A" selected>United States</option>
										<option value="CAN">Canada</option>
										<option value="MEX">Mexico</option>
										<option value="Other">Other</option>
									</select>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div id="existingCustomerForm" class="form-section hidden">
				<h3>Existing Customer Information</h3>
				<div class="form-group">
					<label for="existingEmail">Email *</label>
					<div class="search-container" style="display: flex; gap: 0.5rem">
						<input type="email" id="existingEmail" required style="flex: 1" />
						<button
							type="button"
							id="searchCustomerBtn"
							class="btn"
							style="margin-top: 0; padding: 0.5rem 1rem"
						>
							Search
						</button>
					</div>
					<div
						id="customerSearchStatus"
						style="margin-top: 0.5rem; font-size: 0.9rem"
					></div>
				</div>
				<div id="customerResults" style="margin-top: 1rem; display: none">
					<label>Select Customer:</label>
					<div
						id="customerList"
						style="
							margin-top: 0.5rem;
							display: flex;
							flex-direction: column;
							gap: 0.5rem;
						"
					>
						<!-- Customer buttons will be inserted here -->
					</div>
				</div>
				<div
					id="selectedCustomer"
					style="
						margin-top: 1rem;
						display: none;
						padding: 1rem;
						background: rgba(0, 0, 0, 0.1);
						border-radius: 4px;
					"
				>
					<strong>Selected Customer:</strong>
					<div id="customerDetails" style="margin-top: 0.5rem"></div>
					<div id="addressCards" style="margin-top: 1.5rem"></div>
				</div>
			</div>
			<div id="serialNumberSection" class="form-section">
				<h3>Serial Number</h3>
				<div class="form-group">
					<label for="serialNumber">Serial Number *</label>
					<input type="text" id="serialNumber" required class="form-control" />
					<small class="form-text">Please enter the device serial number</small>
					<div class="invalid-feedback">
						Please provide a valid serial number
					</div>
				</div>
			</div>
			<div class="form-section">
				<button
					type="button"
					class="btn"
					id="submitBtn"
					disabled
					style="opacity: 0.7; cursor: not-allowed"
				>
					Continue to Checkout
				</button>
			</div>
			<div id="errorContainer" class="hidden">
				<p id="errorMessage" style="color: red"></p>
			</div>
		</div>
		<script>
			// --- Address Card UI for Existing Customers ---
			function createAddressCard(address, type, editable, customerId) {
				const card = document.createElement('div');
				card.className = 'address-card';
				card.dataset.type = type;
				const label = document.createElement('div');
				label.className = 'address-label';
				label.textContent =
					type === 'billing' ? 'Billing Address' : 'Shipping Address';
				card.appendChild(label);

				if (editable) {
					const form = document.createElement('form');
					form.className = 'address-form';
					form.innerHTML = `
						<div class="form-group">
							<label>Attention *</label>
							<input type="text" name="attention" required value="${
								address.attention || ''
							}" />
						</div>
						<div class="form-group">
							<label>Street *</label>
							<input type="text" name="street" required value="${address.street || ''}" />
						</div>
						<div class="form-row">
							<div class="form-group form-group-half">
								<label>City *</label>
								<input type="text" name="city" required value="${address.city || ''}" />
							</div>
							<div class="form-group form-group-half">
								<label>State *</label>
								<input type="text" name="state" required value="${address.state || ''}" />
							</div>
						</div>
						<div class="form-row">
							<div class="form-group form-group-half">
								<label>ZIP Code *</label>
								<input type="text" name="zip" required value="${address.zip || ''}" />
							</div>
							<div class="form-group form-group-half">
								<label>Country *</label>
								<select name="country" required>
									<option value="U.S.A" ${
										address.country === 'U.S.A' ? 'selected' : ''
									}>United States</option>
									<option value="CAN" ${
										address.country === 'CAN' ? 'selected' : ''
									}>Canada</option>
									<option value="MEX" ${
										address.country === 'MEX' ? 'selected' : ''
									}>Mexico</option>
									<option value="Other" ${
										address.country === 'Other' ? 'selected' : ''
									}>Other</option>
								</select>
							</div>
						</div>
						<div class="address-actions">
							<button type="submit" class="btn">Save</button>
							<button type="button" class="btn secondary cancel-edit-btn">Cancel</button>
						</div>
					`;
					card.appendChild(form);
					form.addEventListener('submit', async function (e) {
						e.preventDefault();
						const formData = new FormData(form);
						const updatedAddress = {
							attention: formData.get('attention'),
							street: formData.get('street'),
							city: formData.get('city'),
							state: formData.get('state'),
							zip: formData.get('zip'),
							country: formData.get('country'),
						};
						try {
							await updateCustomerAddress(customerId, updatedAddress, type);
							const updatedCustomer = await getCustomerById(customerId);
							selectCustomer(updatedCustomer);
						} catch (err) {
							alert('Failed to update address: ' + (err.message || err));
						}
					});
					form
						.querySelector('.cancel-edit-btn')
						.addEventListener('click', function () {
							renderAddressCards(window.selectedCustomer);
						});
				} else {
					if (
						address &&
						(address.street || address.city || address.state || address.zip)
					) {
						card.innerHTML += `
							<div>
								<div>${address.attention || ''}</div>
								<div>${address.street || ''}</div>
								<div>${address.city || ''}, ${address.state || ''} ${address.zip || ''}</div>
								<div>${address.country || ''}</div>
							</div>
						`;
					} else {
						card.innerHTML += `<div class="address-empty">No ${type} address on file.</div>`;
					}
					const editBtn = document.createElement('button');
					editBtn.type = 'button';
					editBtn.className = 'edit-btn';
					editBtn.title = 'Edit Address';
					editBtn.innerHTML =
						'<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>';
					editBtn.addEventListener('click', function () {
						renderAddressCards(window.selectedCustomer, type);
					});
					card.appendChild(editBtn);
				}
				return card;
			}

			function renderAddressCards(customer, editType = null) {
				const addressCards = document.getElementById('addressCards');
				addressCards.innerHTML = '';
				const customerId = customer.customer_id || customer.id;
				let billing = null,
					shipping = null;
				if (customer.addresses && Array.isArray(customer.addresses)) {
					billing = customer.addresses.find((a) => a.type === 'billing') || {};
					shipping =
						customer.addresses.find((a) => a.type === 'shipping') || {};
				}
				addressCards.appendChild(
					createAddressCard(
						billing,
						'billing',
						editType === 'billing',
						customerId
					)
				);
				addressCards.appendChild(
					createAddressCard(
						shipping,
						'shipping',
						editType === 'shipping',
						customerId
					)
				);
			}

			async function getCustomerById(customerId) {
				const response = await fetch('/api/getCustomer', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ customerId }),
				});
				const data = await response.json();
				if (!response.ok)
					throw new Error(data.error || 'Failed to fetch customer');
				return data.customers ? data.customers[0] : data;
			}

			async function updateCustomerAddress(
				customerId,
				addressData,
				addressType
			) {
				const requestBody = {
					customerId,
					address: { ...addressData, type: addressType },
				};
				const response = await fetch('/api/updateCustomer', {
					method: 'PUT',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(requestBody),
				});
				const result = await response.json();
				if (!response.ok) {
					const errorMsg =
						result.error || `HTTP error! status: ${response.status}`;
					throw new Error(errorMsg);
				}
				return result;
			}

			// --- Customer search and selection logic ---
			document
				.getElementById('searchCustomerBtn')
				.addEventListener('click', searchCustomer);
			document
				.getElementById('existingEmail')
				.addEventListener('keypress', (e) => {
					if (e.key === 'Enter') {
						e.preventDefault();
						searchCustomer();
					}
				});

			function showStatus(message, type = 'info') {
				const statusElement = document.getElementById('customerSearchStatus');
				statusElement.textContent = message;
				statusElement.style.display = 'block';
				statusElement.style.color =
					type === 'error'
						? '#ff4d4f'
						: type === 'success'
						? '#52c41a'
						: type === 'warning'
						? '#faad14'
						: '#1890ff';
			}

			function createCustomerButton(customer) {
				const button = document.createElement('button');
				button.type = 'button';
				button.className = 'customer-btn';
				button.style.cssText = `
					text-align: left;
					padding: 0.75rem;
					border: 1px solid var(--border-color);
					border-radius: var(--radius);
					background: var(--bg-light);
					cursor: pointer;
					transition: all 0.2s;
					box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
				`;
				const displayName =
					customer.display_name ||
					`${customer.first_name || ''} ${customer.last_name || ''}`.trim() ||
					'No name available';
				button.innerHTML = `
					<div style="font-weight: 600; color: var(--text-dark);">${displayName}</div>
					<div style="font-size: 0.9em; color: var(--text-muted);">${customer.email}</div>
				`;
				button.addEventListener('click', () => {
					document.querySelectorAll('.customer-btn').forEach((btn) => {
						btn.style.borderColor = 'var(--border-color)';
						btn.style.backgroundColor = 'var(--bg-light)';
						btn.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05)';
					});
					button.style.borderColor = 'var(--primary-color)';
					button.style.backgroundColor = 'rgba(0, 86, 179, 0.05)';
					button.style.boxShadow = '0 0 0 1px var(--primary-color)';
					selectCustomer(customer);
				});
				return button;
			}

			async function searchCustomer() {
				const email = document.getElementById('existingEmail').value.trim();
				const statusElement = document.getElementById('customerSearchStatus');
				const customerResults = document.getElementById('customerResults');
				const selectedCustomerSection =
					document.getElementById('selectedCustomer');
				customerResults.style.display = 'none';
				selectedCustomerSection.style.display = 'none';
				document.getElementById('customerList').innerHTML = '';
				const submitBtn = document.getElementById('submitBtn');
				submitBtn.disabled = true;
				submitBtn.style.opacity = '0.7';
				submitBtn.style.cursor = 'not-allowed';
				if (!email) {
					showStatus('Please enter an email address', 'error');
					return;
				}
				try {
					showStatus('Searching for customers...', 'info');
					const response = await fetch('/api/getCustomer', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ email }),
					});
					const data = await response.json();
					if (!response.ok)
						throw new Error(data.error || 'Failed to search for customers');
					if (data.customers && data.customers.length > 0) {
						showStatus(`Found ${data.customers.length} customer(s)`, 'success');
						const customerList = document.getElementById('customerList');
						data.customers.forEach((customer) => {
							customerList.appendChild(createCustomerButton(customer));
						});
						customerResults.style.display = 'block';
					} else {
						showStatus('No customers found with this email', 'warning');
					}
				} catch (error) {
					showStatus(error.message || 'Error searching for customers', 'error');
				}
			}

			function selectCustomer(customer) {
				window.selectedCustomer = customer;
				window.selectedCustomerId = customer.customer_id || customer.id;
				console.log('Selected customer:', customer);
				console.log('Set selectedCustomerId:', window.selectedCustomerId);
				const customerDetails = document.getElementById('customerDetails');
				const displayName =
					customer.display_name ||
					`${customer.first_name || ''} ${customer.last_name || ''}`.trim() ||
					'No name available';
				customerDetails.innerHTML = `
					<div><strong>Name:</strong> ${displayName}</div>
					<div><strong>Email:</strong> ${customer.email || 'N/A'}</div>
				`;
				document.getElementById('selectedCustomer').style.display = 'block';
				renderAddressCards(customer);
				const submitBtn = document.getElementById('submitBtn');
				submitBtn.disabled = false;
				submitBtn.style.opacity = '1';
				submitBtn.style.cursor = 'pointer';
			}

			// --- New customer shipping/billing copy logic ---
			function copyBillingToShipping() {
				if (document.getElementById('sameAsBilling').checked) {
					const billingFields = [
						'Attention',
						'Street',
						'City',
						'State',
						'Zip',
						'Country',
					];
					billingFields.forEach((field) => {
						const billingValue = document.getElementById(
							`newBilling${field}`
						).value;
						document.getElementById(`newShipping${field}`).value = billingValue;
					});
				}
			}
			document
				.getElementById('sameAsBilling')
				.addEventListener('change', function () {
					const shippingSection = document.getElementById(
						'shippingAddressSection'
					);
					shippingSection.style.display = this.checked ? 'none' : 'block';
				});
			document
				.getElementById('firstName')
				.addEventListener('input', updateBillingAttention);
			document
				.getElementById('lastName')
				.addEventListener('input', updateBillingAttention);
			function updateBillingAttention() {
				const firstName = document.getElementById('firstName').value;
				const lastName = document.getElementById('lastName').value;
				const fullName = `${firstName} ${lastName}`.trim();
				document.getElementById('newBillingAttention').value = fullName;
				if (document.getElementById('sameAsBilling').checked) {
					document.getElementById('newShippingAttention').value = fullName;
				}
			}
			document
				.querySelectorAll('input[name="customerType"]')
				.forEach((radio) => {
					radio.addEventListener('change', function () {
						const isExisting = radio.value === 'existing';
						document
							.getElementById('newCustomerForm')
							.classList.toggle('hidden', isExisting);
						document
							.getElementById('existingCustomerForm')
							.classList.toggle('hidden', !isExisting);
					});
				});

			function validateForm() {
				const customerType = document.querySelector(
					'input[name="customerType"]:checked'
				)?.value;
				const submitBtn = document.getElementById('submitBtn');

				// Validate serial number (alphanumeric, minimum 14 characters, or specific format like MR40-A1-00003316)
				const serialNumberInput = document.getElementById('serialNumber');
				const serialNumber = serialNumberInput?.value.trim();
				const isSerialValid =
					serialNumber &&
					(/^[a-zA-Z0-9]{14,}$/.test(serialNumber) ||
						/^[A-Z0-9]{2,}-[A-Z0-9]{2,}-[A-Z0-9]{10,}$/.test(serialNumber));

				// Toggle invalid feedback
				if (serialNumberInput) {
					if (serialNumber && !isSerialValid) {
						serialNumberInput.classList.add('is-invalid');
						document.querySelector('.invalid-feedback').style.display = 'block';
					} else {
						serialNumberInput.classList.remove('is-invalid');
						document.querySelector('.invalid-feedback').style.display = 'none';
					}
				}

				if (customerType === 'existing') {
					const isCustomerSelected = !!window.selectedCustomerId;
					const isValid = isCustomerSelected && isSerialValid;
					submitBtn.disabled = !isValid;
					submitBtn.style.opacity = isValid ? '1' : '0.7';
					submitBtn.style.cursor = isValid ? 'pointer' : 'not-allowed';
					return;
				}

				const requiredFields = [
					'firstName',
					'lastName',
					'email',
					'newBillingStreet',
					'newBillingCity',
					'newBillingState',
					'newBillingZip',
					'newBillingCountry',
				];

				const isFormValid =
					requiredFields.every((fieldId) => {
						const element = document.getElementById(fieldId);
						return element && element.value.trim() !== '';
					}) && isSerialValid; // Include serial number validation

				if (!document.getElementById('sameAsBilling').checked) {
					const shippingFields = [
						'newShippingStreet',
						'newShippingCity',
						'newShippingState',
						'newShippingZip',
						'newShippingCountry',
					];
					const isShippingValid = shippingFields.every((fieldId) => {
						const element = document.getElementById(fieldId);
						return element && element.value.trim() !== '';
					});
					const isValid = isFormValid && isShippingValid && isSerialValid;
					submitBtn.disabled = !isValid;
					submitBtn.style.opacity = isValid ? '1' : '0.7';
					submitBtn.style.cursor = isValid ? 'pointer' : 'not-allowed';
				} else {
					submitBtn.disabled = !isFormValid;
					submitBtn.style.opacity = isFormValid ? '1' : '0.7';
					submitBtn.style.cursor = isFormValid ? 'pointer' : 'not-allowed';
				}
			}
			// Add event listeners for form validation
			[
				'firstName',
				'lastName',
				'email',
				'companyName',
				'newBillingStreet',
				'newBillingCity',
				'newBillingState',
				'newBillingZip',
				'newBillingCountry',
				'newShippingStreet',
				'newShippingCity',
				'newShippingState',
				'newShippingZip',
				'newShippingCountry',
				'serialNumber',
			].forEach((fieldId) => {
				const element = document.getElementById(fieldId);
				if (element) element.addEventListener('input', validateForm);
			});
			document
				.querySelectorAll('input[name="customerType"]')
				.forEach((radio) => {
					radio.addEventListener('change', validateForm);
				});

			document
				.getElementById('submitBtn')
				.addEventListener('click', async (e) => {
					e.preventDefault();

					// Validate serial number before submission (alphanumeric, minimum 14 characters, or specific format)
					const serialNumber = document
						.getElementById('serialNumber')
						?.value.trim();
					const isValidFormat =
						serialNumber &&
						(/^[a-zA-Z0-9]{14,}$/.test(serialNumber) ||
							/^[A-Z0-9]{2,}-[A-Z0-9]{2,}-[A-Z0-9]{10,}$/.test(serialNumber));
					if (!isValidFormat) {
						document.getElementById('serialNumber').classList.add('is-invalid');
						document.querySelector('.invalid-feedback').style.display = 'block';
						window.scrollTo({
							top: document.getElementById('serialNumber').offsetTop - 20,
							behavior: 'smooth',
						});
						return;
					}

					try {
						// Default to 'new' customer type since existing customer feature is not yet implemented
						const customerType = 'new';
						// Create payload with serial number and debug logging
						let payload = {
							serial_number: serialNumber,
						};
						console.log(
							'Payload being sent:',
							JSON.stringify(payload, null, 2)
						);
						if (customerType === 'new') {
							const billingAddress = {
								attention: document.getElementById('newBillingAttention').value,
								street: document.getElementById('newBillingStreet').value,
								city: document.getElementById('newBillingCity').value,
								state: document.getElementById('newBillingState').value,
								zip: document.getElementById('newBillingZip').value,
								country: document.getElementById('newBillingCountry').value,
							};
							let shippingAddress;
							if (document.getElementById('sameAsBilling').checked) {
								shippingAddress = { ...billingAddress };
							} else {
								shippingAddress = {
									attention: document.getElementById('newShippingAttention')
										.value,
									street: document.getElementById('newShippingStreet').value,
									city: document.getElementById('newShippingCity').value,
									state: document.getElementById('newShippingState').value,
									zip: document.getElementById('newShippingZip').value,
									country: document.getElementById('newShippingCountry').value,
								};
							}
							payload.customerData = {
								first_name: document.getElementById('firstName').value,
								last_name: document.getElementById('lastName').value,
								email: document.getElementById('email').value,
								company_name: document.getElementById('companyName').value || '',
								display_name: `${document.getElementById('firstName').value} ${
									document.getElementById('lastName').value
								}`.trim(),
								billing_address: billingAddress,
								shipping_address: shippingAddress,
							};
						} else if (customerType === 'existing') {
							if (!window.selectedCustomerId) {
								alert('Please select a customer.');
								return;
							}
							payload.customer_id = window.selectedCustomerId;
						}
						const pathSegments = window.location.pathname
							.split('/')
							.filter(Boolean);

						const short_code = pathSegments[pathSegments.length - 1];

						const submitBtn = document.getElementById('submitBtn');
						submitBtn.disabled = true;
						submitBtn.textContent = 'Processing...';

						console.log('Submitting payload:', payload);

						const response = await fetch(
							`/api/getUrls/checkout/${short_code}`,
							{
								method: 'POST',
								headers: { 'Content-Type': 'application/json' },
								body: JSON.stringify(payload),
							}
						);
						if (!response.ok) {
							const error = await response.json();
							throw new Error(error.message || 'Failed to process payment');
						}
						const result = await response.json();

						const url = new URL(result.hostedPageUrl);
						const urlParams = new URLSearchParams(url.search);
						const urlOrigin = url.origin + url.pathname;

						payload.cf_agent_id = urlParams.get('cf_agent_id') || '';
						payload.cf_dealer_id = urlParams.get('cf_dealer_id') || '';
						payload.source = urlParams.get('source') || 'direct';

						if (result.hostedPageUrl) {
							// --- Log event to Netlify function ---
							const logPayload = {
								plan_id: result.plan_id || '', // or get from your payload if not in result
								checkout_url: urlOrigin,
								cf_agent_id: payload.cf_agent_id || '',
								cf_dealer_id: payload.cf_dealer_id || '',
								cf_dealer_name: urlParams.get('cf_dealer_name') || '',
								cf_distributor_name: urlParams.get('cf_distributor_name') || '',
								cf_distributor_id: urlParams.get('cf_distributor_id') || '',
								cf_dealer_email: urlParams.get('cf_dealer_email') || '',
								source: payload.source || '',
								event_type: 'checkout',
							};

							console.log('Logging event:', logPayload);

							// Fire and forget (don't block redirect)
							fetch('/api/logEvent', {
								method: 'POST',
								headers: { 'Content-Type': 'application/json' },
								body: JSON.stringify(logPayload),
							}).catch((err) => {
								// Optionally log error, but don't block user
								console.error('Failed to log event:', err);
							});

							window.location.href = result.hostedPageUrl;
						} else {
							throw new Error('No hosted page URL received');
						}
					} catch (error) {
						document
							.getElementById('errorContainer')
							.classList.remove('hidden');
						document.getElementById('errorMessage').textContent = `Error: ${
							error.message || 'Failed to process payment. Please try again.'
						}`;
						const submitBtn = document.getElementById('submitBtn');
						submitBtn.disabled = false;
						submitBtn.textContent = 'Submit Order';
					}
				});
		</script>
	</body>
</html>
