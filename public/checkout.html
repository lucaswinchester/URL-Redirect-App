<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Order Form</title>
		<link rel="icon" type="image/svg+xml" href="favicon.svg" />
		<link rel="apple-touch-icon" href="favicon.svg" />
		<link rel="stylesheet" href="style.css" />
		<style>
			/* Using existing styles from style.css */
			body {
				padding-top: 4rem;
				display: flex;
				justify-content: center;
				min-height: 100vh;
				align-items: center;
				box-sizing: border-box;
			}

			html {
				height: 100%;
				scroll-padding-top: 2rem;
			}

			.form-container {
				max-width: 600px;
				width: 100%;
				margin-top: 4rem;
				padding: 1.5rem;
				background: var(--bg-dark);
				border: 1px solid var(--border-color);
				border-radius: var(--radius);
				box-shadow: 0 0 30px rgba(201, 9, 23, 0.2);
				position: relative;
			}

			.form-section {
				margin-bottom: 1.25rem;
			}

			.form-section h3 {
				color: var(--accent-red);
				margin-bottom: 0.75rem;
				font-size: 1.1rem;
			}

			.form-group {
				margin-bottom: 1rem;
			}

			.form-group label {
				display: block;
				margin-bottom: 0.35rem;
				color: var(--text-muted);
				font-size: 0.9rem;
			}

			.form-row {
				display: flex;
				gap: 1rem;
				margin-bottom: 1rem;
			}

			.form-group-half {
				flex: 1;
				min-width: 0;
			}

			.form-group input,
			.form-group select,
			.form-group textarea {
				width: 100%;
				padding: 0.5rem 0.75rem;
				background: var(--bg-dark);
				border: 1px solid var(--border-color);
				border-radius: 6px;
				color: var(--text-light);
				font-size: 0.9rem;
			}

			.form-group textarea {
				min-height: 80px;
				resize: vertical;
			}

			.radio-group {
				margin-bottom: 1rem;
			}

			.radio-group label {
				display: inline-flex;
				align-items: center;
				margin-right: 1.5rem;
				color: var(--text-light);
				cursor: pointer;
				font-size: 0.9rem;
			}

			.radio-group input[type='radio'] {
				margin-right: 0.35rem;
				accent-color: var(--accent-red);
			}

			h1 {
				font-size: 1.5rem;
				margin-bottom: 1.25rem;
			}

			.btn {
				padding: 0.5rem 1.25rem;
				font-size: 0.9rem;
			}
		</style>
	</head>
	<body>
		<div class="form-container">
			<h1>Order Information</h1>

			<div class="form-section">
				<h3>Customer Type</h3>
				<div class="radio-group">
					<label>
						<input type="radio" name="customerType" value="new" checked />
						New Customer
					</label>
					<label>
						<input type="radio" name="customerType" value="existing" />
						Existing Customer
					</label>
				</div>
			</div>

			<div id="newCustomerForm" class="form-section">
				<h3>New Customer Information</h3>
				<div class="form-row">
					<div class="form-group form-group-half">
						<label for="firstName">First Name *</label>
						<input type="text" id="firstName" required />
					</div>
					<div class="form-group form-group-half">
						<label for="lastName">Last Name *</label>
						<input type="text" id="lastName" required />
					</div>
				</div>
				<div class="form-group">
					<label for="email">Email *</label>
					<input type="email" id="email" required />
				</div>
				<div class="form-group">
					<label for="companyName">Company Name (Optional)</label>
					<input type="text" id="companyName" />
				</div>

				<div class="form-section">
					<h3>Billing Address</h3>
					<div class="form-group">
						<label for="billingAttention">Attention *</label>
						<input type="text" id="billingAttention" required />
					</div>
					<div class="form-group">
						<label for="billingStreet">Street *</label>
						<input type="text" id="billingStreet" required />
					</div>
					<div class="form-row">
						<div class="form-group form-group-half">
							<label for="billingCity">City *</label>
							<input type="text" id="billingCity" required />
						</div>
						<div class="form-group form-group-half">
							<label for="billingState">State *</label>
							<input type="text" id="billingState" required />
						</div>
					</div>
					<div class="form-row">
						<div class="form-group form-group-half">
							<label for="billingZip">ZIP Code *</label>
							<input type="text" id="billingZip" required />
						</div>
						<div class="form-group form-group-half">
							<label for="billingCountry">Country *</label>
							<input type="text" id="billingCountry" required value="U.S.A" />
						</div>
					</div>
				</div>

				<div class="form-section">
					<div class="form-group">
						<label>
							<input
								type="checkbox"
								id="sameAsBilling"
								checked
								onchange="copyBillingToShipping()"
							/>
							Shipping address is the same as Billing address
						</label>
					</div>
				</div>

				<div
					id="shippingAddressSection"
					class="form-section"
					style="display: none"
				>
					<h3>Shipping Address</h3>
					<div class="form-group">
						<label for="shippingAttention">Attention *</label>
						<input type="text" id="shippingAttention" />
					</div>
					<div class="form-group">
						<label for="shippingStreet">Street *</label>
						<input type="text" id="shippingStreet" />
					</div>
					<div class="form-row">
						<div class="form-group form-group-half">
							<label for="shippingCity">City *</label>
							<input type="text" id="shippingCity" />
						</div>
						<div class="form-group form-group-half">
							<label for="shippingState">State *</label>
							<input type="text" id="shippingState" />
						</div>
					</div>
					<div class="form-row">
						<div class="form-group form-group-half">
							<label for="shippingZip">ZIP Code *</label>
							<input type="text" id="shippingZip" />
						</div>
						<div class="form-group form-group-half">
							<label for="shippingCountry">Country *</label>
							<input type="text" id="shippingCountry" value="U.S.A" />
						</div>
					</div>
				</div>
			</div>

			<div id="existingCustomerForm" class="form-section hidden">
				<h3>Existing Customer Information</h3>
				<div class="form-group">
					<label for="existingEmail">Email *</label>
					<div class="search-container" style="display: flex; gap: 0.5rem">
						<input type="email" id="existingEmail" required style="flex: 1" />
						<button
							type="button"
							id="searchCustomerBtn"
							class="btn"
							style="margin-top: 0; padding: 0.5rem 1rem"
						>
							Search
						</button>
					</div>
					<div
						id="customerSearchStatus"
						class="hidden"
						style="margin-top: 0.5rem; font-size: 0.9rem; display: none"
					></div>
				</div>
				<div id="customerResults" style="margin-top: 1rem; display: none">
					<label>Select Customer:</label>
					<div
						id="customerList"
						style="
							margin-top: 0.5rem;
							display: flex;
							flex-direction: column;
							gap: 0.5rem;
						"
					>
						<!-- Customer buttons will be inserted here -->
					</div>
				</div>
				<div
					id="selectedCustomer"
					style="
						margin-top: 1rem;
						display: none;
						padding: 1rem;
						background: rgba(0, 0, 0, 0.1);
						border-radius: 4px;
					"
				>
					<strong>Selected Customer:</strong>
					<div id="customerDetails" style="margin-top: 0.5rem"></div>
				</div>
			</div>

			<div class="form-section">
				<button
					type="button"
					class="btn"
					id="submitBtn"
					disabled
					style="opacity: 0.7; cursor: not-allowed"
				>
					Continue to Checkout
				</button>
			</div>

			<div id="errorContainer" class="hidden">
				<p id="errorMessage" style="color: red"></p>
			</div>
		</div>

		<script>
			// Get URL parameters
			const params = new URLSearchParams(window.location.search);
			const planID = params.get('planID');
			const cf_dealer_id = params.get('cf_dealer_id');
			const cf_agent_id = params.get('cf_agent_id');
			const source = params.get('source');

			if (!planID || !cf_dealer_id || !cf_agent_id) {
				document.getElementById('errorContainer').classList.remove('hidden');
				document.getElementById('errorMessage').textContent =
					'Missing required parameters';
			}

			// Toggle form sections based on customer type
			document
				.querySelectorAll('input[name="customerType"]')
				.forEach((radio) => {
					radio.addEventListener('change', () => {
						const isExisting = radio.value === 'existing';
						document
							.getElementById('newCustomerForm')
							.classList.toggle('hidden', isExisting);
						document
							.getElementById('existingCustomerForm')
							.classList.toggle('hidden', !isExisting);
					});
				});

			// Toggle shipping address fields and copy billing to shipping when checked
			document
				.getElementById('sameAsBilling')
				.addEventListener('change', function () {
					const shippingSection = document.getElementById(
						'shippingAddressSection'
					);
					if (this.checked) {
						shippingSection.style.display = 'none';
					} else {
						shippingSection.style.display = 'block';
					}
				});

			// Auto-fill billing attention with full name
			document
				.getElementById('firstName')
				.addEventListener('input', updateBillingAttention);
			document
				.getElementById('lastName')
				.addEventListener('input', updateBillingAttention);

			function updateBillingAttention() {
				const firstName = document.getElementById('firstName').value;
				const lastName = document.getElementById('lastName').value;
				const fullName = `${firstName} ${lastName}`.trim();
				document.getElementById('billingAttention').value = fullName;

				// If same as billing is checked, update shipping attention too
				if (document.getElementById('sameAsBilling').checked) {
					document.getElementById('shippingAttention').value = fullName;
				}
			}

			// Copy billing address to shipping address when checkbox is toggled
			function copyBillingToShipping() {
				if (document.getElementById('sameAsBilling').checked) {
					// Get all billing address fields
					const billingFields = [
						'Attention',
						'Street',
						'City',
						'State',
						'Zip',
						'Country',
					];
					billingFields.forEach((field) => {
						const billingValue = document.getElementById(
							`billing${field}`
						).value;
						document.getElementById(`shipping${field}`).value = billingValue;
					});
				}
			}

			// Add event listeners to update shipping address when billing address changes and checkbox is checked
			[
				'billingStreet',
				'billingCity',
				'billingState',
				'billingZip',
				'billingCountry',
			].forEach((id) => {
				document.getElementById(id).addEventListener('input', function () {
					if (document.getElementById('sameAsBilling').checked) {
						const field = id.replace('billing', '');
						document.getElementById(`shipping${field}`).value = this.value;
					}
				});
			});

			// Add debug logging
			console.log('Script loaded, adding event listeners');

			document
				.getElementById('submitBtn')
				.addEventListener('click', async (e) => {
					try {
						console.log('Submit button clicked');
						e.preventDefault(); // Prevent default form submission
						const customerType = document.querySelector(
							'input[name="customerType"]:checked'
						).value;
						let customerData = {};

						if (customerType === 'new') {
							// Get billing address
							const billingAddress = {
								attention: document.getElementById('billingAttention').value,
								street: document.getElementById('billingStreet').value,
								city: document.getElementById('billingCity').value,
								state: document.getElementById('billingState').value,
								zip: document.getElementById('billingZip').value,
								country: document.getElementById('billingCountry').value,
							};

							// Get shipping address (same as billing if checkbox is checked)
							let shippingAddress;
							if (document.getElementById('sameAsBilling').checked) {
								shippingAddress = { ...billingAddress };
							} else {
								shippingAddress = {
									attention: document.getElementById('shippingAttention').value,
									street: document.getElementById('shippingStreet').value,
									city: document.getElementById('shippingCity').value,
									state: document.getElementById('shippingState').value,
									zip: document.getElementById('shippingZip').value,
									country: document.getElementById('shippingCountry').value,
								};
							}

							customerData = {
								'First Name': document.getElementById('firstName').value,
								'Last Name': document.getElementById('lastName').value,
								Email: document.getElementById('email').value,
								'Company Name': document.getElementById('companyName').value,
								billing_address: billingAddress,
								shipping_address: shippingAddress,
							};
						} else {
							if (!window.selectedCustomerId) {
								throw new Error('Please select a customer');
							}
							customer_id = window.selectedCustomerId;
						}

						// Skip email validation if we have a customer_id
						if (!customer_id) {
							const requiredFields = ['Email'];
							const missingFields = requiredFields.filter(
								(field) => !customerData[field]
							);

							if (missingFields.length > 0) {
								console.log('Missing required fields:', missingFields);
								document
									.getElementById('errorContainer')
									.classList.remove('hidden');
								document.getElementById(
									'errorMessage'
								).textContent = `Please fill in all required fields: ${missingFields.join(
									', '
								)}`;
								return;
							}
						}

						// Prepare URL parameters
						const urlParams = new URLSearchParams({
							planID,
							cf_dealer_id,
							cf_agent_id,
							source,
						});

						// Add customer info based on whether we have an existing customer
						if (customer_id) {
							urlParams.append('customer_id', customer_id);
						} else {
							urlParams.append('customerInfo', JSON.stringify(customerData));
						}

						// Log the data being sent
						console.log('Submitting form with data:', {
							planID,
							cf_dealer_id,
							cf_agent_id,
							source,
							customer_id,
							customerData,
						});

						// Redirect to getUrls with customer information
						const redirectUrl = `/.netlify/functions/getUrls?${urlParams.toString()}`;
						console.log('Redirecting to:', redirectUrl);
						window.location.href = redirectUrl;
					} catch (error) {
						console.error('Error submitting form:', error);
					}
				});

			// Add event listener for customer search
			document
				.getElementById('searchCustomerBtn')
				.addEventListener('click', searchCustomer);

			// Allow pressing Enter in the email field to trigger search
			document
				.getElementById('existingEmail')
				.addEventListener('keypress', (e) => {
					if (e.key === 'Enter') {
						e.preventDefault();
						searchCustomer();
					}
				});

			// Track selected customer
			let selectedCustomer = null;

			// Function to handle customer selection
			function selectCustomer(customer) {
				selectedCustomer = customer;

				// Update selected customer display
				const customerDetails = document.getElementById('customerDetails');
				const displayName =
					customer.display_name ||
					`${customer.first_name || ''} ${customer.last_name || ''}`.trim() ||
					'No name available';

				customerDetails.innerHTML = `
					<div><strong>Name:</strong> ${displayName}</div>
					<div><strong>Email:</strong> ${customer.email}</div>
				`;

				// Show selected customer section
				document.getElementById('selectedCustomer').style.display = 'block';

				// Enable checkout button
				const submitBtn = document.getElementById('submitBtn');
				submitBtn.disabled = false;
				submitBtn.style.opacity = '1';
				submitBtn.style.cursor = 'pointer';

				// Store customer ID for form submission
				window.selectedCustomerId = customer.customer_id;
			}

			// Function to create customer button
			function createCustomerButton(customer) {
				const button = document.createElement('button');
				button.type = 'button';
				button.className = 'customer-btn';
				button.style.cssText = `
					text-align: left;
					padding: 0.75rem;
					border: 1px solid var(--border-color);
					border-radius: var(--radius);
					background: rgba(201, 9, 23, 0.05);
					cursor: pointer;
					transition: all 0.2s;
					box-shadow: 0 0 0 1px rgba(24, 144, 255, 0.2);
				`;

				const displayName =
					customer.display_name ||
					`${customer.first_name || ''} ${customer.last_name || ''}`.trim() ||
					'No name available';

				button.innerHTML = `
					<div style="font-weight: 600;">${displayName}</div>
					<div style="font-size: 0.9em; color: #666;">${customer.email}</div>
				`;

				button.addEventListener('click', () => {
					// Remove active class from all buttons
					document.querySelectorAll('.customer-btn').forEach((btn) => {
						btn.style.borderColor = 'var(--border-color)';
						btn.style.backgroundColor = 'rgba(201, 9, 23, 0.05)';
						btn.style.boxShadow = '0 0 0 1px rgba(24, 144, 255, 0.2)';
					});

					// Add active class to clicked button
					button.style.borderColor = '#c90917';
					button.style.backgroundColor = 'rgba(201, 9, 23, 0.05)';
					button.style.boxShadow = '0 0 0 1px rgba(201, 9, 23, 0.5)';

					// Select the customer
					selectCustomer(customer);
				});

				return button;
			}

			async function searchCustomer() {
				const email = document.getElementById('existingEmail').value.trim();
				const statusElement = document.getElementById('customerSearchStatus');
				const customerResults = document.getElementById('customerResults');
				const selectedCustomerSection =
					document.getElementById('selectedCustomer');

				// Reset state
				customerResults.style.display = 'none';
				selectedCustomerSection.style.display = 'none';
				document.getElementById('customerList').innerHTML = '';

				// Disable checkout button until customer is selected
				const submitBtn = document.getElementById('submitBtn');
				submitBtn.disabled = true;
				submitBtn.style.opacity = '0.7';
				submitBtn.style.cursor = 'not-allowed';

				if (!email) {
					showStatus('Please enter an email address', 'error');
					return;
				}

				try {
					showStatus('Searching for customers...', 'info');

					// Call Netlify function to search for customers
					const response = await fetch('/.netlify/functions/getCustomer', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({ email }),
					});

					const data = await response.json();
					console.log('Customer search response:', data);

					if (!response.ok) {
						throw new Error(data.error || 'Failed to search for customers');
					}

					if (data.customers && data.customers.length > 0) {
						showStatus(`Found ${data.customers.length} customer(s)`, 'success');

						// Add customer buttons to the list
						const customerList = document.getElementById('customerList');
						data.customers.forEach((customer) => {
							customerList.appendChild(createCustomerButton(customer));
						});

						// Show the results
						customerResults.style.display = 'block';
					} else {
						showStatus('No customers found with this email', 'warning');
					}
				} catch (error) {
					console.error('Error searching for customers:', error);
					showStatus(error.message || 'Error searching for customers', 'error');
				}
			}

			function showStatus(message, type = 'info') {
				const statusElement = document.getElementById('customerSearchStatus');
				statusElement.textContent = message;
				statusElement.style.display = 'block';

				// Set color based on message type
				if (type === 'error') {
					statusElement.style.color = '#ff4d4f';
				} else if (type === 'success') {
					statusElement.style.color = '#52c41a';
				} else if (type === 'warning') {
					statusElement.style.color = '#faad14';
				} else {
					statusElement.style.color = '#1890ff';
				}
			}
		</script>
	</body>
</html>
